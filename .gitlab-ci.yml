image: python:3.9

stages:
  - build
  - testing
  - deploy

# Etapa de build
build:
  tags:
    - cicd
  stage: build
  script:
    - whoami
    - pwd
  only:
    - main

# Etapa de testing con pytest
testing:
  tags:
    - cicd
  stage: testing
  script:
    - python -m venv venv  # Crea el entorno virtual
    - source venv/bin/activate  # Activa el entorno virtual
    - export PYTHONPATH=$PYTHONPATH:$CI_PROJECT_DIR  # AÃ±ade el directorio del proyecto al PYTHONPATH
    - pip install -r requirements.txt  # Instala las dependencias necesarias
    - pytest --maxfail=1 --disable-warnings  # Ejecuta pytest
  only:
    - main

# Etapa de deploy
deploy:
  tags:
    - cicd
  stage: deploy
  script:
    - apt-get update && apt-get install -y rsync  # Instalar rsync en el contenedor
    - whoami
    - rsync -Pavz frontend/ /var/frontend/
    - rsync -Pavz api/ /var/api/
  when: manual
  allow_failure: true
  only:
    - main

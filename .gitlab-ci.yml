image: python:3.9  # Usa la imagen de Python directamente sin especificar entrypoint

stages:
  - build
  - testing
  - deploy

# Etapa de build
build:
  tags:
    - cicd
  stage: build 
  script:
    - whoami
    - pwd
  only:
    - main

# Etapa de testing con pytest
testing:
  tags:
    - cicd
  stage: testing
  script:
    - pip install -r requirements.txt  # Instala las dependencias necesarias
    - pytest --maxfail=1 --disable-warnings  # Ejecuta pytest
  only:
    - main

# Etapa de deploy
deploy:
  tags:
    - cicd 
  stage: deploy
  script:
    - whoami
    - mkdir -p /home/moha251mmed/frontend  # Crea el directorio si no existe
    - rsync -Pavz /home/moha251mmed/frontend/ /home/moha251mmed/frontend/
    - mkdir -p /home/moha251mmed/api  # Crea el directorio si no existe
    - rsync -Pavz /home/moha251mmed/api/ /home/moha251mmed/api/
  when: manual 
  only:
    - main

image: python:3.9

stages:
  - build
  - testing
  - deploy

# Etapa de build
build:
  tags:
    - cicd  # Etiqueta agregada para el runner
  stage: build
  script:
    - whoami
    - pwd
  only:
    - main

# Etapa de testing con pytest y artifacts
testing:
  tags:
    - cicd  # Etiqueta agregada para el runner
  stage: testing
  script:
    - python -m venv venv  # Crea el entorno virtual
    - source venv/bin/activate  # Activa el entorno virtual
    - export PYTHONPATH=$PYTHONPATH:$CI_PROJECT_DIR  # Añade el directorio del proyecto al PYTHONPATH
    - pip install -r requirements.txt  # Instala las dependencias necesarias
    - pytest --maxfail=1 --disable-warnings --junitxml=report.xml  # Ejecuta pytest y genera el reporte en formato JUnit
  artifacts:
    when: always  # Siempre guarda los artefactos, incluso si la ejecución falla
    reports:
      junit: report.xml  # Subir el reporte de pruebas en formato JUnit
  only:
    - main

# Etapa de deploy usando SSH y rsync
deploy:
  tags:
    - cicd  # Usa el runner existente
  stage: deploy
  before_script:
  - apt-get update && apt-get install -y rsync openssh-client
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H 34.29.173.5 >> ~/.ssh/known_hosts
  script:
    - whoami
    - rsync -Pavz -e "ssh -o StrictHostKeyChecking=no" frontend/ moha251mmed@34.29.173.5:/var/frontend/  # Copia la carpeta frontend
    - rsync -Pavz -e "ssh -o StrictHostKeyChecking=no" api/ moha251mmed@34.29.173.5:/var/api/  # Copia la carpeta api
  when: manual
  only:
    - main
